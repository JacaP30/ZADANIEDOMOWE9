import streamlit as st
import openai
import pandas as pd
import numpy as np
import pickle
import os
import json
from dotenv import load_dotenv
import re
from datetime import datetime
import base64

from langfuse.decorators import observe
from langfuse.openai import OpenAI


# Langfuse import
try:
    from langfuse import Langfuse
    LANGFUSE_AVAILABLE = True
except ImportError:
    LANGFUSE_AVAILABLE = False



def set_bg(png_file):
    with open(png_file, "rb") as image_file:
        encoded_string = base64.b64encode(image_file.read()).decode()
    css = f"""
    <style>
    .stApp {{
        background-image: url("data:image/png;base64,{encoded_string}");
        background-size: cover;
        background-attachment: fixed;
        background-repeat: no-repeat;
    }}
    
    /* Poprawa czytelno≈õci tekstu */
    .stApp > div > div > div > div {{
        background-color: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 10px;
        backdrop-filter: blur(5px);
        margin: 10px 0;
    }}
    
    /* Style dla g≈Ç√≥wnego contentu */
    .main .block-container {{
        background-color: rgba(255, 255, 255, 0.95);
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 2px 4px 4px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        margin-top: 1rem;
    }}
    
    /* Style dla tytu≈Ç√≥w */
    h1, h2, h3 {{
        color: #0b1e52ff !important;
        text-shadow: 4px 4px 8px #75cfcfff;
        font-weight: bold !important;
    }}
    
    /* Style dla zwyk≈Çego tekstu */
    p, div, span {{
        color: #1f2937 !important;
        text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.8);
    }}
    
    /* Style dla formularzy */
    .stTextInput > div > div > input,
    .stTextArea > div > div > textarea,
    .stSelectbox > div > div > div {{
        background-color: rgba(255, 255, 255, 0.95) !important;
        color: #1f2937 !important;
        border: 2px solid #e5e7eb !important;
        caret-color: #3b82f6 !important;
    }}
    
    /* Kursor w polach tekstowych */
    .stTextArea > div > div > textarea:focus,
    .stTextInput > div > div > input:focus {{
        caret-color: #1e40af !important;
        border-color: #3b82f6 !important;
        outline: none !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }}
    
    /* Style dla etykiet p√≥l tekstowych */
    .stTextArea > label,
    .stTextInput > label {{
        color: #02040aff !important;   
        font-weight: bold !important;
        text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9) !important;
        font-size: 16px !important;
    }}
    
    /* Style dla przycisk√≥w */
    .stButton > button {{
        background-color: #3b82f6 !important;
        color: white !important;
        border: none !important;
        border-radius: 8px !important;
        font-weight: bold !important;
        text-shadow: none !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }}
    
    .stButton > button:hover {{
        background-color: #2563eb !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
    }}
    
    /* Style dla metrics */
    .metric-container {{
        background-color: rgba(255, 255, 255, 0.9) !important;
        padding: 15px !important;
        border-radius: 8px !important;
        border: 1px solid #e5e7eb !important;
    }}
    
    /* Style dla alert√≥w i komunikat√≥w */
    .stAlert {{
        background-color: rgba(255, 255, 255, 0.95) !important;
        border-radius: 8px !important;
        backdrop-filter: blur(5px) !important;
    }}
    
    /* Style dla success/error/info/warning */
    .stSuccess, .stError, .stInfo, .stWarning {{
        background-color: rgba(255, 255, 255, 0.95) !important;
        color: #1f2937 !important;
        border-radius: 8px !important;
        backdrop-filter: blur(5px) !important;
    
    }}
    
    /* Style dla stopki */
    .footer {{
        background-color: rgba(255, 255, 255, 0.9) !important;
        padding: 10px !important;
        border-radius: 8px !important;
        margin-top: 20px !important;
    }}
    </style>
    """
    st.markdown(css, unsafe_allow_html=True)

# U≈ºycie:
set_bg("images/background.png")# import matplotlib.patheffects


# Za≈Çaduj zmienne ≈õrodowiskowe
load_dotenv()

# Konfiguracja OpenAI
openai.api_key = os.getenv("OPENAI_API_KEY")

# Konfiguracja Langfuse (opcjonalna)
langfuse_client = None
if LANGFUSE_AVAILABLE:
    # Sprawd≈∫ zmienne ≈õrodowiskowe
    secret_key = os.getenv("LANGFUSE_SECRET_KEY")
    public_key = os.getenv("LANGFUSE_PUBLIC_KEY")
    host = os.getenv("LANGFUSE_HOST", "https://cloud.langfuse.com")
    
    print(f"üîç Langfuse config check:")
    print(f"  - SECRET_KEY: {'‚úÖ Set' if secret_key else '‚ùå Missing'}")
    print(f"  - PUBLIC_KEY: {'‚úÖ Set' if public_key else '‚ùå Missing'}")
    print(f"  - HOST: {host}")
    
    if secret_key and public_key:
        try:
            langfuse_client = Langfuse(
                secret_key=secret_key,
                public_key=public_key,
                host=host
            )
            print("‚úÖ Langfuse initialized successfully")
        except Exception as e:
            print(f"‚ö†Ô∏è Langfuse initialization failed: {e}")
            langfuse_client = None
    else:
        print("‚ö†Ô∏è Langfuse keys missing - skipping initialization")
else:
    print("‚ö†Ô∏è Langfuse not available - library not installed")


def log_to_langfuse(function_name, input_data, output_data, metadata=None):
    """Loguj wywo≈Çanie funkcji do Langfuse"""
    if langfuse_client is None:
        return
    
    try:
        trace = langfuse_client.trace(
            name=function_name,
            input=input_data,
            output=output_data,
            metadata=metadata or {}
        )
        # Flush natychmiast aby dane zosta≈Çy wys≈Çane
        langfuse_client.flush()
        return trace
    except Exception as e:
        print(f"Langfuse logging error: {e}")
        return None

def load_model():
    """Za≈Çaduj wytrenowany model regresji PyCaret"""
    try:
        # Import PyCaret functions
        from pycaret.regression import load_model as pycaret_load_model, predict_model as pycaret_predict_model
        
        # Za≈Çaduj model PyCaret
        model = pycaret_load_model('model/app_zad_dom_9_regressor')
        return model
    except Exception as e:
        st.error(f"B≈ÇƒÖd podczas ≈Çadowania modelu: {e}")
        return None

def extract_user_data(user_input):
    """WyciƒÖgnij wszystkie dane u≈ºytkownika z tekstu u≈ºywajƒÖc AI"""
    try:
        response = openai.chat.completions.create(
            model="gpt-4",
            messages=[
                {
                    "role": "system",
                    "content": """Jeste≈õ ekspertem w analizie tekstu. Twoim zadaniem jest wyciƒÖgniƒôcie nastƒôpujƒÖcych informacji z podanego tekstu:
                    1. Imiƒô
                    2. Wiek (w latach) lub rok urodzenia
                    3. P≈Çeƒá (M dla mƒô≈ºczyzny, K dla kobiety)
                    4. Czas na 5km (w minutach, mo≈ºe byƒá w formacie MM:SS lub jako liczba minut)
                    
                    Zwr√≥ƒá odpowied≈∫ w formacie JSON:
                    {
                        "name": "imiƒô lub null",
                        "age": liczba_lat lub null,
                        "birth_year": rok_urodzenia lub null,
                        "gender": "M" lub "K" lub null,
                        "time_5k_minutes": liczba_minut lub null
                    }
                    
                    Je≈õli nie mo≈ºesz okre≈õliƒá p≈Çci z tekstu, spr√≥buj wywnioskowaƒá jƒÖ z imienia.
                    Je≈õli podano czas w formacie MM:SS, przekonwertuj na minuty (np. 25:30 = 25.5).
                    Obecny rok: {datetime.now().year}"""
                },
                {
                    "role": "user", 
                    "content": f"Tekst u≈ºytkownika: {user_input}"
                }
            ],
            temperature=0.1,
            max_tokens=200
        )
        
        result = response.choices[0].message.content
        if not result:
            return None
        result = result.strip()
        
        # Spr√≥buj sparsowaƒá JSON
        try:
            data = json.loads(result)
            
            # Loguj do Langfuse
            log_to_langfuse(
                function_name="extract_user_data",
                input_data={"user_input": user_input},
                output_data=data,
                metadata={
                    "model": "gpt-4",
                    "temperature": 0.1,
                    "max_tokens": 200
                }
            )
            
            return data
        except json.JSONDecodeError:
            # Je≈õli nie uda≈Ço siƒô sparsowaƒá JSON, zwr√≥ƒá None
            return None
            
    except Exception as e:
        st.error(f"B≈ÇƒÖd podczas komunikacji z AI: {e}")
        return None

def infer_gender_from_name(name):
    """Wywnioskuj p≈Çeƒá na podstawie imienia u≈ºywajƒÖc AI"""
    try:
        response = openai.chat.completions.create(
            model="gpt-4",
            messages=[
                {
                    "role": "system",
                    "content": """Jeste≈õ ekspertem w rozpoznawaniu p≈Çci na podstawie imion. 
                    Zwr√≥ƒá tylko 'M' dla mƒô≈ºczyzny, 'K' dla kobiety lub 'NIEZNANA' je≈õli nie mo≈ºesz okre≈õliƒá p≈Çci.
                    Bierz pod uwagƒô imiona z r√≥≈ºnych kultur i jƒôzyk√≥w."""
                },
                {
                    "role": "user",
                    "content": f"JakƒÖ p≈Çeƒá ma osoba o imieniu: {name}?"
                }
            ],
            temperature=0.1,
            max_tokens=10
        )
        
        result = response.choices[0].message.content
        if result:
            result = result.strip().upper()
            if result in ['M', 'K']:
                # Loguj do Langfuse
                log_to_langfuse(
                    function_name="infer_gender_from_name",
                    input_data={"name": name},
                    output_data={"gender": result},
                    metadata={
                        "model": "gpt-4",
                        "temperature": 0.1,
                        "max_tokens": 10
                    }
                )
                return result
        return None
            
    except Exception as e:
        st.error(f"B≈ÇƒÖd podczas rozpoznawania p≈Çci: {e}")
        return None

def predict_half_marathon_time(model, gender, age, time_5k):
    """Przewiduj czas p√≥≈Çmaratonu na podstawie danych u≈ºytkownika"""
    try:
        from pycaret.regression import predict_model as pycaret_predict_model
        
        # Oblicz rok urodzenia z wieku
        birth_year = datetime.now().year - age
        
        # Kodowanie p≈Çci: M=1, K=0 (zgodnie z treningiem)
        gender_encoded = 1 if gender == 'M' else 0
        
        # Przygotuj dane wej≈õciowe zgodnie z formatem z notebooka
        # Model oczekuje: '≈öredni Czas na 5 km', 'Rocznik', 'P≈Çeƒá_LE'
        input_data = pd.DataFrame([{
            '≈öredni Czas na 5 km': time_5k,  # czas w sekundach
            'Rocznik': birth_year,
            'P≈Çeƒá_LE': gender_encoded
        }])
        
        # Dokonaj predykcji u≈ºywajƒÖc PyCaret
        prediction_df = pycaret_predict_model(model, data=input_data)
        prediction = prediction_df['prediction_label'].iloc[0]
        
        return prediction
        
    except Exception as e:
        st.error(f"B≈ÇƒÖd podczas predykcji: {e}")
        return None

def format_time(seconds):
    """Formatuj czas z sekund na format HH:MM:SS"""
    hours = int(seconds // 3600)
    minutes = int((seconds % 3600) // 60)
    seconds = int(seconds % 60)
    return f"{hours:02d}:{minutes:02d}:{seconds:02d}"

def main():
    st.title("Predyktor Czasu P√≥≈Çmaratonu")
    # st.markdown("---")
    
    # Za≈Çaduj model
    model = load_model()
    if model is None:
        st.stop()
    
    st.markdown("### Opowiedz o sobie:")
    
    # Instrukcje dla u≈ºytkownika
    st.info("""
    üìù **Podaj nastƒôpujƒÖce informacje w dowolnej formie:**
    - **Imiƒô**,  **Wiek**,  **Czas na 5km**,  **P≈Çeƒá** (je≈õli chcesz)
    
    üí° **Przyk≈Çady:**
    - "Nazywam siƒô Kasia, urodzi≈Çam siƒô w 1990 roku, 5km w 26.5 minuty"
    - "Jestem Anna, mam 28 lat i biegam 5km w 24 minuty"
    - "Marek, 35 lat, czas na 5km: 22:45"    
    - Mo≈ºesz te≈º po prostu "Janek 75 25"  :)
    """)
    
    # Formularz dla u≈ºytkownika
    with st.form("user_data_form"):
        user_input = st.text_area(
            "## **Wpisz informacje o sobie:**",
            height=100,
            placeholder="Napisz co≈õ o sobie... ",
            help="Podaj swoje dane w dowolnej formie - AI wyciƒÖgnie potrzebne informacje"
        )
        
        submitted = st.form_submit_button("üîç Analizuj i przewiduj czas p√≥≈Çmaratonu", use_container_width=True)
    
    if submitted:
        if not user_input.strip():
            st.error("Proszƒô podaƒá informacje o sobie!")
            st.stop()
        
        # Analiza danych przez AI
        with st.spinner("ü§ñ AI analizuje Twoje dane..."):
            extracted_data = extract_user_data(user_input.strip())
            
            if not extracted_data:
                st.error("Nie uda≈Ço siƒô przetworzyƒá danych. Spr√≥buj podaƒá informacje w innej formie.")
                st.stop()
        
        # Wy≈õwietl wyciƒÖgniƒôte dane
        st.markdown("### üîç Dane wyciƒÖgniƒôte przez AI:")
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            name = extracted_data.get('name')
            if name:
                st.success(f"**Imiƒô:** {name}")
            else:
                st.warning("**Imiƒô:** nie rozpoznano")
        
        with col2:
            age = extracted_data.get('age')
            birth_year = extracted_data.get('birth_year')
            
            if age:
                st.success(f"**Wiek:** {age} lat")
                if not birth_year:
                    birth_year = datetime.now().year - age
            elif birth_year:
                age = datetime.now().year - birth_year
                st.success(f"**Wiek:** {age} lat (ur. {birth_year})")
            else:
                st.error("**Wiek:** nie rozpoznano")
        
        with col3:
            gender = extracted_data.get('gender')
            if gender:
                gender_text = "Mƒô≈ºczyzna" if gender == 'M' else "Kobieta"
                st.success(f"**P≈Çeƒá:** {gender_text}")
            else:
                # Spr√≥buj wywnioskowaƒá z imienia
                if name:
                    st.info("Rozpoznawanie p≈Çci z imienia...")
                    gender = infer_gender_from_name(name)
                    if gender:
                        gender_text = "Mƒô≈ºczyzna" if gender == 'M' else "Kobieta"
                        st.success(f"**P≈Çeƒá:** {gender_text} (z imienia)")
                    else:
                        st.error("**P≈Çeƒá:** nie rozpoznano")
                else:
                    st.error("**P≈Çeƒá:** nie rozpoznano")
        
        with col4:
            time_5k = extracted_data.get('time_5k_minutes')
            if time_5k:
                st.success(f"**5km:** {time_5k} min")
            else:
                st.error("**Czas 5km:** nie rozpoznano")
        
        # Sprawd≈∫ czy mamy wszystkie potrzebne dane
        missing_data = []
        if not name:
            missing_data.append("imiƒô")
        if not age:
            missing_data.append("wiek")
        if not gender:
            missing_data.append("p≈Çeƒá")
        if not time_5k:
            missing_data.append("czas na 5km")
        
        if missing_data:
            st.error(f"‚ùå Brakuje nastƒôpujƒÖcych danych: {', '.join(missing_data)}")
            st.info("üí° Spr√≥buj podaƒá informacje w bardziej szczeg√≥≈Çowy spos√≥b lub w innym formacie.")
            st.stop()
        
        # Predykcja
        # st.markdown("---")
        with st.spinner("üèÉ‚Äç‚ôÇÔ∏è Przewidywanie czasu p√≥≈Çmaratonu..."):
            
            # Konwersja czasu 5km na sekundy
            time_5k_seconds = time_5k * 60
            
            # Predykcja
            predicted_time = predict_half_marathon_time(model, gender, age, time_5k_seconds)
            
            if predicted_time is not None:
                # Loguj ca≈ÇkowitƒÖ predykcjƒô do Langfuse
                log_to_langfuse(
                    function_name="half_marathon_prediction",
                    input_data={
                        "name": name,
                        "age": age,
                        "gender": gender,
                        "time_5k_minutes": time_5k,
                        "original_input": user_input
                    },
                    output_data={
                        "predicted_time_seconds": predicted_time,
                        "predicted_time_formatted": format_time(predicted_time)
                    },
                    metadata={
                        "model_type": "pycaret_regression",
                        "features": ["≈öredni Czas na 5 km", "Rocznik", "P≈Çeƒá_LE"]
                    }
                )
                
                # G≈Ç√≥wny wynik
                # st.markdown("---")
                predicted_time_formatted = format_time(predicted_time)
                
                st.markdown(f"""
                <div style="
                    text-align: center; 
                    padding: 25px; 
                    border: 3px solid #4CAF50; 
                    border-radius: 15px; 
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
                    backdrop-filter: blur(10px);
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                    margin: 20px 0;
                ">
                    <h2 style="
                        color: #2E7D32 !important; 
                        margin-bottom: 15px;
                        text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
                        font-weight: bold;
                    ">üèÉ‚Äç‚ôÇÔ∏è Przewidywany czas p√≥≈Çmaratonu:</h2>
                    <h1 style="
                        color: #1B5E20 !important; 
                        font-size: 3.5em; 
                        margin: 10px 0;
                        text-shadow: 3px 3px 6px rgba(255, 255, 255, 0.9);
                        font-weight: bold;
                        letter-spacing: 2px;
                    ">{predicted_time_formatted}</h1>
                </div>
                """, unsafe_allow_html=True)
                
                # Dodatkowe informacje
                # st.markdown("---")
                st.markdown("### üìä Analiza:")
                
                # Oblicz tempo na km dla p√≥≈Çmaratonu
                pace_per_km = predicted_time / 21.1
                pace_minutes = int(pace_per_km // 60)
                pace_seconds = int(pace_per_km % 60)
                
                col1, col2 = st.columns(2)
                with col1:
                    st.info(f"**Tempo na km:** {pace_minutes}:{pace_seconds:02d} min/km")
                
                with col2:
                    # Por√≥wnanie z czasem 5km
                    pace_5k = (time_5k * 60) / 5
                    pace_5k_min = int(pace_5k // 60)
                    pace_5k_sec = int(pace_5k % 60)
                    st.info(f"**Tempo 5km:** {pace_5k_min}:{pace_5k_sec:02d} min/km")
                
                # MotywujƒÖcy komentarz
                st.success("üí™ Powodzenia w treningu! Pamiƒôtaj, ≈ºe regularne treningi sƒÖ kluczem do sukcesu.")
                
                # Opcja ponownej analizy
                #st.markdown("---")
                if st.button("üîÑ Analizuj inne dane"):
                    st.rerun()

if __name__ == "__main__":
    main()
